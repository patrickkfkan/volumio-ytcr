{"version":3,"file":"VideoLoader.js","sourceRoot":"","sources":["../../src/lib/VideoLoader.ts"],"names":[],"mappings":"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","sourcesContent":["import Innertube, * as InnertubeLib from 'volumio-youtubei.js';\nimport { VideoInfo as InnertubeVideoInfo } from 'volumio-youtubei.js/dist/src/parser/youtube/index.js';\nimport Format from 'volumio-youtubei.js/dist/src/parser/classes/misc/Format.js';\nimport { Logger, Video } from 'yt-cast-receiver';\nimport { AbortSignal } from 'abort-controller';\nimport fetch from 'node-fetch';\nimport ytcr from './YTCRContext.js';\n\n// https://gist.github.com/sidneys/7095afe4da4ae58694d128b1034e01e2\nconst ITAG_TO_BITRATE = {\n  '139': '48',\n  '140': '128',\n  '141': '256',\n  '171': '128',\n  '249': '50',\n  '250': '70',\n  '251': '160'\n} as Record<string, string>;\n\nconst BEST_AUDIO_FORMAT = {\n  type: 'audio',\n  format: 'any',\n  quality: 'best'\n} as InnertubeLib.FormatOptions;\n\nexport interface VideoInfo {\n  id: string,\n  errMsg?: string,\n  title?: string,\n  channel?: string,\n  thumbnail?: string,\n  isLive?: boolean,\n  streamUrl?: string | null,\n  bitrate?: string,\n  samplerate?: number,\n  channels?: number\n}\n\ninterface StreamInfo {\n  url: string | null,\n  mimeType?: string,\n  bitrate?: string | null,\n  sampleRate?: number,\n  channels?: number\n}\n\nexport default class VideoLoader {\n\n  #innertube: Innertube | null;\n  #logger: Logger;\n\n  constructor(logger: Logger) {\n    this.#innertube = null;\n    this.#logger = logger;\n  }\n\n  async #init() {\n    if (!this.#innertube) {\n      this.#innertube = await Innertube.create();\n    }\n  }\n\n  async getInfo(video: Video, abortSignal: AbortSignal): Promise<VideoInfo> {\n    if (!this.#innertube) {\n      await this.#init();\n    }\n    if (!this.#innertube) {\n      throw Error('VideoLoader not initialized');\n    }\n\n    this.#logger.debug(`[ytcr] VideoLoader.getInfo: ${video.id}`);\n\n    if (abortSignal) {\n      abortSignal.onabort = () => {\n        const abortError = Error(`VideoLoader.getInfo() aborted for video Id: ${video.id}`);\n        abortError.name = 'AbortError';\n        throw abortError;\n      };\n    }\n\n    // Prepare endpoint for innertube.getInfo()\n    const endpoint = new InnertubeLib.YTNodes.NavigationEndpoint({});\n    endpoint.payload = {\n      videoId: video.id\n    };\n    if (video.context?.playlistId) {\n      endpoint.payload.playlistId = video.context.playlistId;\n    }\n    if (video.context?.params) {\n      endpoint.payload.params = video.context.params;\n    }\n    if (video.context?.index !== undefined) {\n      endpoint.payload.index = video.context.index;\n    }\n    // Modify innertube's session context to include `ctt` param\n    if (video.context?.ctt) {\n      this.#innertube.session.context.user = {\n        enableSafetyMode: false,\n        lockedSafetyMode: false,\n        credentialTransferTokens: [\n          {\n            'scope': 'VIDEO',\n            'token': video.context?.ctt\n          }\n        ]\n      } as any;\n    }\n    else {\n      delete (this.#innertube.session.context.user as any)?.credentialTransferTokens;\n    }\n\n    try {\n      const info = await this.#innertube.getInfo(endpoint);\n\n      const basicInfo = info.basic_info;\n      const title = basicInfo.title;\n      const channel = basicInfo.author;\n      const thumbnail = this.#getThumbnail(basicInfo.thumbnail);\n      const isLive = !!basicInfo.is_live;\n\n      let playable = false;\n      let errMsg = null;\n      let streamInfo = null;\n      if (info.playability_status.status === 'UNPLAYABLE') {\n        if (info.has_trailer) {\n          const trailerInfo = info.getTrailerInfo();\n          if (trailerInfo) {\n            streamInfo = this.#chooseFormat(trailerInfo);\n          }\n        }\n        else {\n          errMsg = info.playability_status.reason;\n        }\n      }\n      else if (!isLive) {\n        streamInfo = this.#chooseFormat(info);\n      }\n      else if (info.streaming_data?.hls_manifest_url) {\n        const targetQuality = ytcr.getConfigValue('liveStreamQuality', 'auto');\n        streamInfo = {\n          url: await this.#getStreamUrlFromHLS(info.streaming_data.hls_manifest_url, targetQuality)\n        };\n      }\n\n      playable = !!streamInfo?.url;\n\n      if (!playable && !errMsg) {\n        errMsg = ytcr.getI18n('YTCR_STREAM_NOT_FOUND');\n      }\n\n      return {\n        id: video.id,\n        errMsg: errMsg || undefined,\n        title,\n        channel,\n        thumbnail,\n        isLive,\n        streamUrl: streamInfo?.url,\n        bitrate: streamInfo?.bitrate || undefined,\n        samplerate: streamInfo?.sampleRate,\n        channels: streamInfo?.channels\n      };\n\n    }\n    catch (error) {\n      this.#logger.error(`[ytcr] Error in VideoLoader.getInfo(${video.id}):`, error);\n      return {\n        id: video.id,\n        errMsg: error instanceof Error ? error.message : '(Check logs for errors)'\n      };\n    }\n  }\n\n  #getThumbnail(data: any): string {\n    const url = data?.[0]?.url;\n    if (url?.startsWith('//')) {\n      return `https:${url}`;\n    }\n    return url;\n  }\n\n  #chooseFormat(videoInfo: InnertubeVideoInfo) {\n    if (!this.#innertube) {\n      throw Error('VideoLoader not initialized');\n    }\n    const format = videoInfo?.chooseFormat(BEST_AUDIO_FORMAT);\n    const streamUrl = format ? format.decipher(this.#innertube.session.player) : null;\n    const streamData = format ? { ...format, url: streamUrl } as Format : null;\n    if (streamData) {\n      return this.#parseStreamData(streamData);\n    }\n    return null;\n  }\n\n  #parseStreamData(data: Format): StreamInfo {\n    const audioBitrate = ITAG_TO_BITRATE[`${data.itag}`];\n\n    return {\n      url: data.url,\n      mimeType: data.mime_type,\n      bitrate: audioBitrate ? `${audioBitrate} kbps` : null,\n      sampleRate: data.audio_sample_rate,\n      channels: data.audio_channels\n    };\n  }\n\n  async #getStreamUrlFromHLS(manifestUrl: string, targetQuality?: string): Promise<string | null> {\n    if (!targetQuality || targetQuality === 'auto') {\n      return manifestUrl;\n    }\n\n    const res = await fetch(manifestUrl);\n    const manifestContents = await res.text();\n\n    // Match Resolution and Url\n    const regex = /#EXT-X-STREAM-INF.*RESOLUTION=(\\d+x\\d+).*[\\r\\n](.+)/gm;\n\n    const playlistVariants = [];\n\n    // Modified from regex101's code generator :)\n    let m;\n    while ((m = regex.exec(manifestContents)) !== null) {\n      if (m.index === regex.lastIndex) {\n        regex.lastIndex++;\n      }\n\n      const variant: any = {};\n      playlistVariants.push(variant);\n\n      m.forEach((match, groupIndex) => {\n        if (groupIndex === 1) { // Resolution\n          variant.quality = `${match.split('x')[1]}p`;\n        }\n        if (groupIndex === 2) {\n          variant.url = match;\n        }\n      });\n    }\n\n    // Find matching variant or closest one that is lower than targetQuality\n    const targetQualityInt = parseInt(targetQuality);\n    const diffs = playlistVariants.map((variant) => ({\n      variant,\n      qualityDelta: targetQualityInt - parseInt(variant.quality)\n    }));\n    const closest = diffs.filter((v) => v.qualityDelta >= 0).sort((v1, v2) => v1.qualityDelta - v2.qualityDelta)[0];\n\n    return closest?.variant.url || playlistVariants[0]?.url || null;\n  }\n}\n"]}