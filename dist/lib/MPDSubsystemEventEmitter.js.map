{"version":3,"file":"MPDSubsystemEventEmitter.js","sourceRoot":"","sources":["../../src/lib/MPDSubsystemEventEmitter.ts"],"names":[],"mappings":"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","sourcesContent":["import { MPDApi } from 'mpd-api';\nimport { Logger } from 'yt-cast-receiver';\n\nexport type SubsystemName = 'database' |\n                            'update' |\n                            'stored_playlist' |\n                            'playlist' |\n                            'player' |\n                            'mixer' |\n                            'output' |\n                            'options' |\n                            'partition' |\n                            'sticker' |\n                            'subscription' |\n                            'message' |\n                            'neighbor' |\n                            'mount';\n\ninterface SubsystemEventListener {\n  (event: SubsystemEvent): Promise<void>;\n}\n\ninterface __SubsystemEventListener {\n  once: boolean;\n  callback: SubsystemEventListener;\n}\n\nexport class SubsystemEvent {\n  #name: string;\n  #propagate: boolean;\n\n  constructor(name: string, propagate = true) {\n    this.#name = name;\n    this.#propagate = propagate;\n  }\n\n  stopPropagation() {\n    this.#propagate = false;\n  }\n\n  get propagate(): boolean {\n    return this.#propagate;\n  }\n\n  get name(): string {\n    return this.#name;\n  }\n}\n\nexport default class MPDSubsystemEventEmitter {\n\n  #status: string;\n  #mpdClient: MPDApi.ClientAPI;\n  #logger: Logger;\n  #systemEventListener: (subsystem: SubsystemName) => Promise<void>;\n  #subsystemEventListeners: {[subsystem: string]: __SubsystemEventListener[]};\n\n  constructor(logger: Logger) {\n    this.#logger = logger;\n    this.#status = 'stopped';\n    this.#systemEventListener = this.#handleSystemEvent.bind(this);\n    this.#subsystemEventListeners = {};\n  }\n\n  static instance(mpdClient: MPDApi.ClientAPI, logger: Logger) {\n    const emitter = new MPDSubsystemEventEmitter(logger);\n    emitter.#mpdClient = mpdClient;\n    return emitter;\n  }\n\n  enable() {\n    if (this.#status === 'stopped') {\n      this.#mpdClient.on('system', this.#systemEventListener);\n      this.#status = 'running';\n      this.#logger.debug('[ytcr] MPDSubsystemEventEmitter enabled.');\n    }\n  }\n\n  disable() {\n    this.#status = 'stopped';\n    this.#mpdClient.removeListener('system', this.#systemEventListener);\n    this.#logger.debug('[ytcr] MPDSubsystemEventEmitter disabled.');\n  }\n\n  #addSubsystemEventListener(event: SubsystemName, listener: SubsystemEventListener, once = false, prepend = false) {\n    if (!this.#subsystemEventListeners[event]) {\n      this.#subsystemEventListeners[event] = [];\n    }\n    const wrapped = {\n      once,\n      callback: listener\n    };\n    if (prepend) {\n      this.#subsystemEventListeners[event].unshift(wrapped);\n    }\n    else {\n      this.#subsystemEventListeners[event].push(wrapped);\n    }\n  }\n\n  on(event: SubsystemName, listener: SubsystemEventListener): this {\n    this.#addSubsystemEventListener(event, listener);\n    return this;\n  }\n\n\n  once(event: SubsystemName, listener: SubsystemEventListener): this {\n    this.#addSubsystemEventListener(event, listener, true);\n    return this;\n  }\n\n  off(event: SubsystemName, listener: SubsystemEventListener): this {\n    const listeners = this.#subsystemEventListeners[event];\n    if (!listeners) {\n      return this;\n    }\n\n    this.#subsystemEventListeners[event] = listeners.filter((l) => l.callback !== listener);\n    return this;\n  }\n\n  prependOnceListener(event: SubsystemName, listener: SubsystemEventListener): this {\n    this.#addSubsystemEventListener(event, listener, true, true);\n    return this;\n  }\n\n  async #handleSystemEvent(subsystem: SubsystemName) {\n    if (this.#status === 'running') {\n      const listeners = this.#subsystemEventListeners[subsystem];\n      if (!listeners) {\n        return;\n      }\n\n      this.#logger.debug(`[ytcr] MPDSubsystemEventEmitter invoking ${listeners.length} SubsystemEventListener callbacks for: ${subsystem}`);\n\n      for (let i = 0; i < listeners.length; i++) {\n        const l = listeners[i];\n        const event = new SubsystemEvent(subsystem);\n        try {\n          const callbackResult = l.callback(event);\n          if (callbackResult.then !== undefined) {\n            await callbackResult;\n          }\n        }\n        catch (error) {\n          this.#logger.debug('[ytcr] MPDSubsystemEventEmitter handleSystemEvent error:', error);\n        }\n        if (!event.propagate) {\n          this.#logger.debug('[ytcr] SubsystemEvent.propagate: false. Event propagation stopped.');\n          break;\n        }\n      }\n\n      this.#subsystemEventListeners[subsystem] = listeners.filter((l) => !l.once);\n    }\n  }\n}\n"]}