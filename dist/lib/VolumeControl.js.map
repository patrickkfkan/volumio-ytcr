{"version":3,"file":"VolumeControl.js","sourceRoot":"","sources":["../../src/lib/VolumeControl.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger, Volume } from 'yt-cast-receiver';\nimport { kewToJSPromise } from './Utils.js';\n\nexport interface VolumioVolume {\n  vol: number;\n  mute: boolean;\n}\n\ninterface VolumioVolumeChangeListener {\n  (volume: VolumioVolume): Promise<void>;\n}\n\nexport default class VolumeControl {\n\n  #commandRouter: any;\n  #logger: Logger;\n  #currentVolume: Volume | null;\n  #volumioVolumeChangeListener: VolumioVolumeChangeListener | null;\n\n  constructor(commandRouter: any, logger: Logger) {\n    this.#commandRouter = commandRouter;\n    this.#logger = logger;\n    this.#currentVolume = null;\n    this.#volumioVolumeChangeListener = null;\n  }\n\n  async init() {\n    this.#currentVolume = await this.getVolume();\n    this.#logger.debug('[ytcr] VolumeControl initialized with current volume:', this.#currentVolume);\n  }\n\n  async setVolume(volume: Volume, setInternalOnly = false) {\n    const oldVolume = this.#currentVolume;\n    this.#currentVolume = volume;\n    if (!setInternalOnly) {\n      try {\n        if (oldVolume?.level !== volume.level) {\n          this.#logger.debug(`[ytcr] VolumeControl setting Volumio's volume level to: ${volume.level}`);\n          this.#commandRouter.volumiosetvolume(volume.level);\n        }\n        if (oldVolume?.muted !== volume.muted) {\n          this.#logger.debug(`[ytcr] VolumeControl setting Volumio's mute status to: ${volume.muted}`);\n          this.#commandRouter.volumiosetvolume(volume.muted ? 'mute' : 'unmute');\n        }\n      }\n      catch (error) {\n        this.#logger.error('[ytcr] Failed to set Volumio\\'s volume:', error);\n        this.#currentVolume = null;\n      }\n    }\n  }\n\n  async getVolume(): Promise<Volume> {\n    if (this.#currentVolume === null) {\n      try {\n        const volumioVolume = await kewToJSPromise(this.#commandRouter.volumioretrievevolume());\n        this.#currentVolume = {\n          level: volumioVolume.vol,\n          muted: volumioVolume.mute\n        };\n      }\n      catch (error: any) {\n        this.#logger.error('[ytcr] VolumeControl failed to obtain volume from Volumio:', error);\n        this.#currentVolume = null;\n        return {\n          level: 0,\n          muted: false\n        };\n      }\n    }\n    return this.#currentVolume;\n  }\n\n  registerVolumioVolumeChangeListener(listener: VolumioVolumeChangeListener) {\n    if (this.#volumioVolumeChangeListener) {\n      this.unregisterVolumioVolumeChangeListener();\n    }\n    this.#volumioVolumeChangeListener = listener;\n    this.#commandRouter.addCallback('volumioupdatevolume', listener);\n  }\n\n  unregisterVolumioVolumeChangeListener() {\n    if (!this.#volumioVolumeChangeListener) {\n      return;\n    }\n    const callbacks = this.#commandRouter.callbacks['volumioupdatevolume'];\n    if (callbacks) {\n      const oldCount = callbacks.length;\n      this.#logger.debug(`[ytcr] VolumeControl removing Volumio callbacks for 'volumioupdatevolume'. Current count: ${oldCount}`);\n      this.#commandRouter.callbacks['volumioupdatevolume'] = callbacks.filter((l: any) => l !== this.#volumioVolumeChangeListener);\n      const newCount = this.#commandRouter.callbacks['volumioupdatevolume'].length;\n      this.#logger.debug(`[ytcr] VolumeControl removed ${oldCount - newCount} Volumio callbacks for 'volumioupdatevolume'.`);\n    }\n  }\n}\n"]}